<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>生产订单管理</title>

    <link rel="stylesheet" href="/static/lib/layui-v2.8.17/css/layui.css" media="all">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <!-- Bootstrap Icons CDN -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body {
            padding: 15px;
            background: #f8f9fa;
        }
        .search-card {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<!-- 查询条件 -->
<div class="card search-card">
    <div class="card-body">
        <form id="searchForm">
            <div class="row g-2 align-items-center">

                <!-- 订单号 -->
                <div class="col-md-3">
                    <input type="text" class="form-control" name="orderNo" placeholder="订单号">
                </div>

                <!-- 客户 -->
                <div class="col-md-3">
                    <select class="form-select customer-select" name="customer">
                        <option value="" selected>搜索客户</option>
                        <option th:each="customer : ${customers}"
                                th:value="${customer.name}"
                                th:text="${customer.name}">
                        </option>
                    </select>
                </div>

                <!-- 状态 -->
                <div class="col-md-2">
                    <select name="status" class="form-select">
                        <option value="">订单状态</option>
                        <option value="0">待排产</option>
                        <option value="1">已排产</option>
                        <option value="2">已完成</option>
                    </select>
                </div>

                <!-- 交货期（Layui 日期控件） -->
                <div class="col-md-2">
                    <input type="text" id="deliveryDate" class="form-control" name="deliveryDate" placeholder="请选择交货期" autocomplete="off">
                </div>

                <!-- 按钮 -->
                <div class="col-md-2 text-end">
                    <button type="button" class="btn btn-primary" id="btnSearch">查询</button>
                    <button type="button" class="btn btn-success" id="btnAdd">新增</button>
                </div>

            </div>
        </form>
    </div>
</div>
<!-- 编辑订单弹窗 -->
<div id="editOrderTpl" style="display:none;padding:20px;">
    <form class="layui-form" lay-filter="editOrderForm">

        <input type="hidden" name="id">
        <!-- 订单号（只读） -->
        <div class="layui-form-item">
            <label class="layui-form-label">订单号</label>
            <div class="layui-input-block">
                <input type="text" name="orderNo" class="layui-input" readonly>
            </div>
        </div>

        <!-- 客户 -->
        <div class="layui-form-item">
            <label class="layui-form-label">客户</label>
            <div class="layui-input-block">
                <select name="customer" lay-search required>
                    <option value="">搜索客户</option>
                    <option th:each="customer : ${customers}"
                            th:value="${customer.name}"
                            th:text="${customer.name}">
                    </option>
                </select>
            </div>
        </div>
        <!-- 内外轮 -->
        <div class="layui-form-item">
            <label class="layui-form-label">内外轮</label>
            <div class="layui-input-block">
                <select name="outerInnerRing" required>
                    <option value="">请选择</option>
                    <option value="LA">LA</option>
                    <option value="LB">LB</option>
                    <option value="LAB">LAB</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">型号</label>
            <div class="layui-input-block">
                <input type="text" name="model" class="layui-input">
            </div>
        </div>

        <!-- 数量 -->
        <div class="layui-form-item">
            <label class="layui-form-label">数量</label>
            <div class="layui-input-block">
                <input type="number" name="quantity" required class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">交货期</label>
            <div class="layui-input-block">
                <input type="date" name="deliveryDate" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">状态</label>
            <div class="layui-input-block">
                <select name="status">
                    <option value="0">待排产</option>
                    <option value="1">已排产</option>
                    <option value="2">已完成</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="editSubmit">确认</button>
            </div>
        </div>
    </form>
</div>

<!-- 表格 -->
<table id="orderTable" lay-filter="orderTable"></table>

<!-- 行操作按钮 -->
<script type="text/html" id="rowBar">
    <button class="btn btn-sm btn-outline-primary me-1" lay-event="edit">编辑</button>
    <button class="btn btn-sm btn-outline-danger" lay-event="del">删除</button>
</script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="/static/js/http_code.jquery.com_jquery-3.6.0.min.js"></script>
<script src="/static/lib/layui-v2.8.17/layui.js"></script>

<script>
    function formatDate(dateStr) {
        if (!dateStr) return '';
        let date = new Date(dateStr);
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        return dateStr.substring(0, 10);
    }


    layui.use(['table', 'form','layer','laydate'], function () {
        var table = layui.table;
        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;
        laydate.render({
            elem: '#deliveryDate',   // 绑定元素
            type: 'date',            // 日期类型
            format: 'yyyy-MM-dd',    // 显示格式
            theme: 'molv',           // 可选主题
            trigger: 'click'         // 点击弹出
        });
        // 表格初始化
        table.render({
            elem: '#orderTable',
            url: '/production-order/list',     //  对齐后端
            method: 'get',
            request: {
                pageName: 'page',   // 后端分页参数
                limitName: 'size'
            },
            height: 600, // 设置表格高度
            parseData: function (res) {
                // 适配 Result + MyBatis-Plus Page
                return {
                    code: 0,
                    msg: '',
                    count: res.data.total,
                    data: res.data.records
                };
            },
            toolbar: ['filter', 'exports', 'print'],
            cols: [ [
                {field: 'id', title: 'ID', hidden: true},
                {field: 'orderNo', title: '订单号',},
                {field: 'customer', title: '客户', },
                {field: 'outerInnerRing', title: '内外轮', },
                {field: 'model', title: '型号', },
                {field: 'quantity', title: '数量', },
                {field: 'deliveryDate', title: '交货期', templet: function(d) {
                        return formatDate(d.deliveryDate);
                    }},
                {
                    field: 'status',
                    title: '状态',
                    templet: function (d) {
                        if (d.status === '0') return '<span class="text-primary">待排产</span>';
                        if (d.status === '1') return '<span class="text-success">已排产</span>';
                        if (d.status === '2') return '<span class="text-success">已完成</span>';
                        return '<span class="text-secondary">新建</span>';
                    }
                },
                {field: 'createdAt', title: '创建时间', hide:true,templet: function(d) {return formatDate(d.createdAt);}},
                {fixed: 'right', title: '操作', toolbar: '#rowBar', }
            ]],
            limits:[50,500,5000,50000],
            limit:50,
            page: true //开启分页
        });

        // 查询
        $('#btnSearch').click(function () {
            table.reload('orderTable', {
                where: $('#searchForm').serializeObject(),
                page: {curr: 1}
            });
        });

        // 新增
        $('#btnAdd').click(function () {
            layer.open({
                type: 2,
                title: '新增生产订单',
                area: ['80%', '60%'],
                content: '/productionOrder',
                end: function () {
                    table.reload('orderTable');
                }
            });
        });

        // 行操作（编辑 / 删除）
        table.on('tool(orderTable)', function (obj) {
            var data = obj.data;

            if (obj.event === 'edit') {

                layer.open({
                    type: 1,
                    title: '编辑订单',
                    area: ['600px', '700'],
                    content: $('#editOrderTpl'),
                    success: function () {

                        // 填充表单
                        form.val('editOrderForm', {
                            id: data.id,
                            orderNo:data.orderNo,
                            outerInnerRing: data.outerInnerRing,
                            customer: data.customer,
                            model: data.model,
                            quantity: data.quantity,
                            deliveryDate: formatDateForInput(data.deliveryDate),
                            status: data.status
                        });

                        form.render();
                    }
                });
            }

            if (obj.event === 'del') {
                layer.confirm('确认删除该订单？', function () {
                    $.ajax({
                        url: '/production-order/' + data.id,
                        type: 'DELETE',
                        success: function (res) {
                            if (res.code === 200) {
                                layer.msg('删除成功');
                                table.reload('orderTable');
                            } else {
                                layer.alert(res.msg);
                            }
                        }
                    });
                });
            }
        });
        form.on('submit(editSubmit)', function (formObj) {

            $.ajax({
                url: '/production-order/update',
                type: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(formObj.field),
                success: function (res) {
                    if (res.code === 200) {
                        layer.msg('修改成功');
                        layer.closeAll();
                        table.reload('orderTable');
                    } else {
                        layer.alert(res.msg);
                    }
                }
            });

            return false;
        });

    });

    // 表单序列化工具
    $.fn.serializeObject = function () {
        var obj = {};
        this.serializeArray().forEach(function (item) {
            if (item.value) obj[item.name] = item.value;
        });
        return obj;
    };
</script>

</body>
</html>
