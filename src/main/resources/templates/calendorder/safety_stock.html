<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®¢æˆ·å®‰å…¨åº“å­˜ç®¡ç†</title>

    <link rel="stylesheet" href="/static/lib/layui-v2.8.17/css/layui.css" media="all">
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/css/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

    <style>
        body { padding: 15px; background: #f8f9fa; }
        .search-card { margin-bottom: 15px; }
        .select2-container { width: 100% !important; }
    </style>
</head>
<body>

<!-- æŸ¥è¯¢æ¡ä»¶ -->
<div class="card search-card">
    <div class="card-body">
        <form id="searchForm">
            <div class="row g-2 align-items-center">

                <!-- å®¢æˆ· -->
                <div class="col-md-3">
                    <select class="form-select customer-select" name="customer">
                        <option value="">æ‰€æœ‰å®¢æˆ·</option>
                        <option th:each="customer : ${customers}"
                                th:value="${customer.name}"
                                th:text="${customer.name}">
                        </option>
                    </select>
                </div>

                <!-- å†…å¤–è½® -->
                <div class="col-md-2">
                    <select class="form-select" name="outerInnerRing">
                        <option value="">å…¨éƒ¨å†…å¤–è½®</option>
                        <option value="LA">LA</option>
                        <option value="LB">LB</option>
                        <option value="LAB">LAB</option>
                    </select>
                </div>

                <!-- å‹å· -->
                <div class="col-md-3">
                    <input type="text" class="form-control" name="model" placeholder="å‹å·">
                </div>

                <!-- æŒ‰é’® -->
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-primary" id="btnSearch">æŸ¥è¯¢</button>
<!--                    <button type="button" class="btn btn-success" id="btnAdd">æ–°å¢</button>-->
                    <button type="button" class="btn btn-warning" id="btnUpdateCustomerCycle">
                        å®¢æˆ·æ•´ä½“ä¿®æ”¹
                    </button>
                </div>

            </div>
        </form>
    </div>
</div>
<div id="customerCycleTpl" style="display:none; padding: 20px;">
    <form class="layui-form" lay-filter="customerCycleForm">
        <div class="layui-form-item">
            <label class="layui-form-label">å®¢æˆ·</label>
            <div class="layui-input-block">
                <input type="text" name="customerName" class="layui-input layui-bg-gray" readonly>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">å‘¨æœŸ</label>
            <div class="layui-input-block">
                <input type="number" name="stockCycle" class="layui-input"
                       placeholder="è¯·è¾“å…¥åº“å­˜å‘¨æœŸï¼ˆæœˆï¼‰" lay-verify="required">
            </div>
        </div>

        <div class="layui-form-item" style="margin-top: 25px; text-align: center;">
            <button class="layui-btn layui-btn-normal" lay-submit lay-filter="customerCycleSubmit">
                ç¡®è®¤ä¿®æ”¹
            </button>
        </div>
    </form>
</div>
<!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
<div id="editStockTpl" style="display:none;padding:20px;">
    <form class="layui-form" lay-filter="editStockForm">

        <input type="hidden" name="id">

        <div class="layui-form-item">
            <label class="layui-form-label">å®¢æˆ·</label>
            <div class="layui-input-block">
                <select name="customer" lay-search required>
                    <option value="">è¯·é€‰æ‹©å®¢æˆ·</option>
                    <option th:each="customer : ${customers}"
                            th:value="${customer.name}"
                            th:text="${customer.name}">
                    </option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">å†…å¤–è½®</label>
            <div class="layui-input-block">
                <select name="outerInnerRing" required>
                    <option value="">è¯·é€‰æ‹©</option>
                    <option value="LA">LA</option>
                    <option value="LB">LB</option>
                    <option value="LAB">LAB</option>
                </select>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">å‹å·</label>
            <div class="layui-input-block">
                <input type="text" name="model" class="layui-input">
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">åº“å­˜å‘¨æœŸ(æœˆ)</label>
            <div class="layui-input-block">
                <input type="number" name="stockCycle" class="layui-input" required>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="editSubmit">ç¡®è®¤</button>
            </div>
        </div>

    </form>
</div>

<!-- è¡¨æ ¼ -->
<table class="layui-table" id="safetyStockTable" lay-filter="stockTable"></table>

<!-- è¡Œæ“ä½œæ¨¡æ¿ï¼ˆå¯é€‰åˆ é™¤/ç¼–è¾‘ï¼‰ -->
<script type="text/html" id="rowBar">
    <button class="btn btn-sm btn-outline-primary me-1" lay-event="edit">ç¼–è¾‘</button>
    <button class="btn btn-sm btn-outline-danger" lay-event="del">åˆ é™¤</button>
</script>

<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="/static/js/http_code.jquery.com_jquery-3.6.0.min.js"></script>
<script src="/static/lib/layui-v2.8.17/layui.js"></script>

<script>
    function formatDate(dateStr) {
        if (!dateStr) return '';
        let date = new Date(dateStr);
        let year = date.getFullYear();
        let month = (date.getMonth() + 1).toString().padStart(2, '0');
        let day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function formatDateForInput(dateStr) {
        if (!dateStr) return '';
        return dateStr.substring(0, 10);
    }
    layui.use(['table','form','layer'], function(){
        var table = layui.table;
        var form  = layui.form;   // ğŸ”¥ å¿…é¡»åŠ è¿™ä¸€è¡Œ
        var layer = layui.layer;
        table.render({
            elem: '#safetyStockTable',
            url: '/safety-stock/list',
            method: 'get',
            request: { pageName: 'page', limitName: 'size' },
            parseData: function(res){
                return {
                    code: 0,
                    msg: '',
                    count: res.data.total,
                    data: res.data.records
                };
            },
            cols:[ [
                {field:'customer', title:'å®¢æˆ·'},
                {field:'outerInnerRing', title:'å†…å¤–è½®'},
                {field:'model', title:'å‹å·'},
                {field:'stockCycle', title:'åº“å­˜å‘¨æœŸ(æœˆ)', edit:'text'},
                {field:'updatedAt', title:'æ›´æ–°æ—¶é—´', templet: function(d){ return formatDate(d.updatedAt) },hide:true}
            ]],
            page:true
        });

        // å•å…ƒæ ¼ç¼–è¾‘ä¿å­˜
        table.on('edit(stockTable)', function(obj){
            var data = { id: obj.data.id, stockCycle: obj.value };
            fetch('/safety-stock/save', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(data)
            }).then(res => res.json())
                .then(res => {
                    if(res.code === 0){
                        layer.msg('æ›´æ–°æˆåŠŸ');
                    } else {
                        layer.msg('æ›´æ–°å¤±è´¥: ' + res.msg);
                    }
                });
        });
        $('#btnUpdateCustomerCycle').on('click', function () {
            var customer = $('select[name="customer"]').val();
            if (!customer) {
                layer.msg('è¯·å…ˆé€‰æ‹©å®¢æˆ·');
                return;
            }

            layer.open({
                type: 1,
                title: 'å®¢æˆ·æ•´ä½“åº“å­˜å‘¨æœŸä¿®æ”¹',
                area: ['450px', 'auto'],
                content: $('#customerCycleTpl'),
                success: function () {
                    form.val('customerCycleForm', {
                        customerName: customer,
                        stockCycle: ''
                    });
                    form.render();
                }
            });
        });
        form.on('submit(customerCycleSubmit)', function (data) {
            var field = data.field; // è·å¾—è¡¨å•å­—æ®µ
            var customer = field.customerName;
            var stockCycle = parseFloat(field.stockCycle);
            if (isNaN(stockCycle)) {
                layer.msg('åº“å­˜å‘¨æœŸå¿…é¡»æ˜¯æ•°å­—');
                return false;
            }

            if (stockCycle < 0) {
                layer.msg('åº“å­˜å‘¨æœŸä¸èƒ½ä¸ºè´Ÿæ•°');
                return false;
            }

// æœ€å¤šä¸¤ä½å°æ•°ï¼ˆå’Œåç«¯ä¸€è‡´ï¼‰
            if (!/^\d+(\.\d{1,2})?$/.test(field.stockCycle)) {
                layer.msg('åº“å­˜å‘¨æœŸæœ€å¤šæ”¯æŒä¸¤ä½å°æ•°');
                return false;
            }
            // æ˜¾ç¤ºåŠ è½½å±‚ï¼Œé˜²æ­¢é‡å¤æäº¤
            var loading = layer.load(2);

            fetch('/safety-stock/updateCustomerCycle', {
                method: 'PUT', // ç¡®è®¤ä½ çš„åç«¯æ¥å£æ˜¯ PUT è¿˜æ˜¯ POST
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    customer: customer,
                    stockCycle: stockCycle
                })
            })
                .then(res => res.json())
                .then(res => {
                    layer.close(loading); // å…³é—­åŠ è½½å±‚
                    if (res.code === 200) {
                        // 1. æˆåŠŸæç¤º
                        layer.msg('ä¿®æ”¹æˆåŠŸ', {icon: 1, time: 1000}, function(){
                            // 2. å…³é—­å½“å‰æ‰€æœ‰çš„ layer å¼¹çª—
                            layer.closeAll('page');

                            // 3. åˆ·æ–°è¡¨æ ¼
                            // æ³¨æ„ï¼šè¿™é‡Œ reload çš„ ID å¿…é¡»ä¸ table.render ä¸­çš„ id ä¸€è‡´
                            table.reload('safetyStockTable', {
                                where: {
                                    customer: customer // å¦‚æœå¸Œæœ›åˆ·æ–°ååªçœ‹è¯¥å®¢æˆ·ï¼Œä¿ç•™æ­¤è¡Œ
                                },
                                page: { curr: 1 } // å¯é€‰ï¼šå›åˆ°ç¬¬ä¸€é¡µ
                            });
                        });
                    } else {
                        layer.msg(res.msg || 'ä¿®æ”¹å¤±è´¥', {icon: 2});
                    }
                })
                .catch(err => {
                    layer.close(loading);
                    layer.msg('ç½‘ç»œå¼‚å¸¸æˆ–æœåŠ¡å™¨é”™è¯¯', {icon: 2});
                });

            return false; // é˜»æ­¢è¡¨å•åŸç”Ÿè·³è½¬
        });
        // æŸ¥è¯¢æŒ‰é’®
        $('#btnSearch').on('click', function(){
            var formData = $('#searchForm').serializeArray();
            var params = {};
            formData.forEach(item => { params[item.name] = item.value; });
            table.reload('safetyStockTable', { where: params, page: { curr: 1 } });
        });


        // ç›‘å¬å•å…ƒæ ¼ç¼–è¾‘
        table.on('edit(stockTable)', function(obj){
            fetch('/safety-stock/save',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(obj.data)
            });
        });
    });
</script>

</body>
</html>