<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>生产履历查询</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding: 16px; }
        .table td, .table th { vertical-align: middle; }
    </style>
</head>
<body>
<div class="card mb-3">
    <div class="card-body">
        <div class="row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">产线</label>
                <select id="lineId" class="form-select">
                    <option value="">全部产线</option>
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">事件类型</label>
                <select id="eventType" class="form-select">
                    <option value="">全部类型</option>
                    <option value="1">生产</option>
                    <option value="2">换型</option>
                    <option value="3">停机</option>
                    <option value="4">维护</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">开始时间</label>
                <input id="startTime" type="datetime-local" class="form-control">
            </div>
            <div class="col-md-3">
                <label class="form-label">结束时间</label>
                <input id="endTime" type="datetime-local" class="form-control">
            </div>
            <div class="col-md-1 d-grid gap-2">
                <button class="btn btn-primary" id="btnSearch">查询</button>
            </div>
            <div class="col-12">
                <button class="btn btn-outline-secondary" id="btnReset">重置</button>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-hover bg-white">
                <thead class="table-light">
                <tr>
                    <th>产线编码</th>
                    <th>产线名称</th>
                    <th>型号</th>
                    <th>事件类型</th>
                    <th>开始时间</th>
                    <th>结束时间</th>
                    <th>持续时长(分钟)</th>
                    <th>备注</th>
                    <th>创建时间</th>
                </tr>
                </thead>
                <tbody id="tableBody">
                <tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>
                </tbody>
            </table>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <div>共 <span id="totalCount">0</span> 条</div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="prevPage">上一页</button>
                <span>第 <span id="currentPage">1</span> / <span id="totalPage">1</span> 页</span>
                <button class="btn btn-outline-secondary btn-sm" id="nextPage">下一页</button>
                <select class="form-select form-select-sm" id="pageSize" style="width: 100px;">
                    <option value="10" selected>10条/页</option>
                    <option value="20">20条/页</option>
                    <option value="50">50条/页</option>
                </select>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/http_code.jquery.com_jquery-3.6.0.min.js"></script>
<script>
    let pageState = { page: 1, size: 10, total: 0 };

    function safeText(value) {
        return value == null ? '' : String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function formatDateTime(v) {
        if (!v) return '';
        const d = new Date(v);
        if (isNaN(d.getTime())) return v;
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        const hh = String(d.getHours()).padStart(2, '0');
        const mm = String(d.getMinutes()).padStart(2, '0');
        const ss = String(d.getSeconds()).padStart(2, '0');
        return `${y}-${m}-${day} ${hh}:${mm}:${ss}`;
    }

    function toQueryDateTime(v) {
        if (!v) return '';
        return v.replace('T', ' ') + ':00';
    }

    function eventTypeText(type) {
        const map = { 1: '生产', 2: '换型', 3: '停机', 4: '维护' };
        return map[Number(type)] || ('类型' + safeText(type));
    }

    function loadLineOptions() {
        return $.ajax({
            url: '/api/model-config/line-options',
            method: 'GET',
            success: function (res) {
                if (!res || res.code !== 200) {
                    return;
                }
                const options = (res.data || []).map(line =>
                    `<option value="${line.id}">${safeText(line.lineCode)} - ${safeText(line.lineName)}</option>`
                ).join('');
                $('#lineId').append(options);
            }
        });
    }

    function renderRows(records) {
        if (!records.length) {
            $('#tableBody').html('<tr><td colspan="9" class="text-center text-muted">暂无数据</td></tr>');
            return;
        }

        const rows = records.map(item => `<tr>
            <td>${safeText(item.lineCode)}</td>
            <td>${safeText(item.lineName)}</td>
            <td>${safeText(item.model)}</td>
            <td>${safeText(eventTypeText(item.eventType))}</td>
            <td>${safeText(formatDateTime(item.startTime))}</td>
            <td>${safeText(formatDateTime(item.endTime))}</td>
            <td>${safeText(item.durationMinutes)}</td>
            <td>${safeText(item.remark)}</td>
            <td>${safeText(formatDateTime(item.createTime))}</td>
        </tr>`).join('');

        $('#tableBody').html(rows);
    }

    function loadList() {
        $.ajax({
            url: '/api/history/list',
            method: 'GET',
            data: {
                page: pageState.page,
                size: pageState.size,
                lineId: $('#lineId').val() || null,
                eventType: $('#eventType').val() || null,
                startTime: toQueryDateTime($('#startTime').val()),
                endTime: toQueryDateTime($('#endTime').val())
            },
            success: function (res) {
                if (!res || res.code !== 200) {
                    alert(res ? res.msg : '查询失败');
                    return;
                }

                const data = res.data || {};
                const records = data.records || [];
                pageState.total = Number(data.total || 0);
                renderRows(records);

                const totalPage = Math.max(1, Math.ceil(pageState.total / pageState.size));
                $('#totalCount').text(pageState.total);
                $('#currentPage').text(pageState.page);
                $('#totalPage').text(totalPage);
                $('#prevPage').prop('disabled', pageState.page <= 1);
                $('#nextPage').prop('disabled', pageState.page >= totalPage);
            },
            error: function () {
                alert('查询失败');
            }
        });
    }

    $(function () {
        loadLineOptions().then(loadList);

        $('#btnSearch').on('click', function () {
            pageState.page = 1;
            loadList();
        });

        $('#btnReset').on('click', function () {
            $('#lineId').val('');
            $('#eventType').val('');
            $('#startTime').val('');
            $('#endTime').val('');
            pageState.page = 1;
            loadList();
        });

        $('#pageSize').on('change', function () {
            pageState.size = Number($(this).val() || 10);
            pageState.page = 1;
            loadList();
        });

        $('#prevPage').on('click', function () {
            if (pageState.page > 1) {
                pageState.page -= 1;
                loadList();
            }
        });

        $('#nextPage').on('click', function () {
            const totalPage = Math.max(1, Math.ceil(pageState.total / pageState.size));
            if (pageState.page < totalPage) {
                pageState.page += 1;
                loadList();
            }
        });
    });
</script>
</body>
</html>
